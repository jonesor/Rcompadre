<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vectorizing with Rcompadre • Rcompadre</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Vectorizing with Rcompadre">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Rcompadre</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/AgeFromStage.html">Age-from-stage analyses</a>
    </li>
    <li>
      <a href="../articles/GettingStarted.html">Getting Started with Rcompadre</a>
    </li>
    <li>
      <a href="../articles/ObtainingReferences.html">Obtaining References</a>
    </li>
    <li>
      <a href="../articles/RcompadreTidy.html">Using Rcompadre with the Tidyverse</a>
    </li>
    <li>
      <a href="../articles/TernaryPlot.html">Ternary Plots</a>
    </li>
    <li>
      <a href="../articles/VectorizingRcompadre.html">Vectorizing with Rcompadre</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Vectorizing with Rcompadre</h1>
                        <h4 class="author">Patrick Barks</h4>
            
            <h4 class="date">2019-12-10</h4>
      
      
      <div class="hidden name"><code>VectorizingRcompadre.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>COM(P)ADRE databases contain thousands of matrix population models. If we want to derive traits from a large set of these matrices, we’ll need to use either loops or vectorization.</p>
<p>Vectorizing means applying a function to each element of a vector. Here vector is defined broadly — it could be a sequence of character strings, a column of a data frame, a list of matrices, etc. Vectorized code generally runs faster than loops, and many R users find that vectorized code is easier to write and understand.</p>
</div>
<div id="preliminaries" class="section level2">
<h2 class="hasAnchor">
<a href="#preliminaries" class="anchor"></a>Preliminaries</h2>
<p>We’ll start by loading a few packages and a dataset that we’ll be using throughout this vignette. The dataset <code>Compadre</code> is a subset of a recent COMPADRE release that’s built into Rcompadre.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(Rcompadre)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(popbio)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(Compadre)</a></code></pre></div>
</div>
<div id="introduction-to-vectorization" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction-to-vectorization" class="anchor"></a>Introduction to vectorization</h2>
<p>To understand vectorization, we first need a vector. For this purpose, we’ll extract a list of <strong>A</strong> matrices from the <code>mat</code> column of <code>Compadre</code>, and add this list of matrices to <code>Compadre</code> as a new column.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">Compadre<span class="op">$</span>matA &lt;-<span class="st"> </span><span class="kw"><a href="../reference/CompadreMatrixMethods.html">matA</a></span>(Compadre)</a></code></pre></div>
<p>This new column, <code>Compadre$matA</code>, is both a vector and a list.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/vector">is.vector</a></span>(Compadre<span class="op">$</span>matA)   <span class="co"># it really is a vector</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; [1] TRUE</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">is.list</a></span>(Compadre<span class="op">$</span>matA)     <span class="co"># and also a list</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt; [1] TRUE</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(Compadre<span class="op">$</span>matA)      <span class="co"># with 150 matrices</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt; [1] 150</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">Compadre<span class="op">$</span>matA[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]         <span class="co"># here are the first three</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co">#&gt;        A1   A2   A3   A4</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#&gt; [1,] 0.61 0.38 0.30 1.16</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="co">#&gt; [2,] 0.23 0.50 0.31 0.32</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="co">#&gt; [3,] 0.00 0.18 0.54 0.41</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co">#&gt; [4,] 0.00 0.05 0.08 0.50</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="co">#&gt;          A1    A2    A3       A4       A5        A6</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="co">#&gt; [1,] 0.8430 0.000 0.000 176.0600 635.7200 1601.2500</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="co">#&gt; [2,] 0.0003 0.000 0.000   0.0584   0.2109    0.5313</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="co">#&gt; [3,] 0.0000 0.476 0.132   0.1430   0.0000    0.0560</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="co">#&gt; [4,] 0.0000 0.095 0.105   0.2860   0.0000    0.0000</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21"><span class="co">#&gt; [5,] 0.0000 0.167 0.474   0.4290   0.8000    0.0000</span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22"><span class="co">#&gt; [6,] 0.0000 0.143 0.237   0.0710   0.2000    0.8890</span></a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24"><span class="co">#&gt; [[3]]</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="co">#&gt;         A1    A2    A3</span></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"><span class="co">#&gt; [1,] 0.017 0.000 1.142</span></a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="co">#&gt; [2,] 0.655 0.902 0.009</span></a>
<a class="sourceLine" id="cb3-28" data-line-number="28"><span class="co">#&gt; [3,] 0.000 0.001 0.988</span></a></code></pre></div>
<p>Let’s say we want to calculate the dimension of every matrix in <code>Compadre$matA</code>. In fact, <code>Compadre</code> already has this data in the column ‘MatrixDimension’, but let’s say we want to double-check it. We’ll use the function <code><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow()</a></code>, and assume that the number of rows and columns are equal. But we can’t use <code><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow()</a></code> directly on <code>Compadre$matA</code>, because the function <code><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow()</a></code> isn’t vectorized. It can only take one object at a time.</p>
<div id="manual-approach" class="section level4">
<h4 class="hasAnchor">
<a href="#manual-approach" class="anchor"></a>Manual approach</h4>
<p>We could do something like this…</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">Compadre<span class="op">$</span>dim &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(Compadre))  <span class="co"># create empty vector to store output</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">Compadre<span class="op">$</span>dim[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(Compadre<span class="op">$</span>matA[[<span class="dv">1</span>]])  <span class="co"># nrow matrix 1</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">Compadre<span class="op">$</span>dim[<span class="dv">2</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(Compadre<span class="op">$</span>matA[[<span class="dv">2</span>]])  <span class="co"># nrow matrix 2</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">Compadre<span class="op">$</span>dim[<span class="dv">3</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(Compadre<span class="op">$</span>matA[[<span class="dv">3</span>]])  <span class="co"># nrow matrix 3</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co"># ... all the way to 150</span></a></code></pre></div>
<p>But that’s not very efficient for 150 matrices.</p>
</div>
<div id="loop-approach" class="section level4">
<h4 class="hasAnchor">
<a href="#loop-approach" class="anchor"></a>Loop approach</h4>
<p>A loop would be much more efficient here.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># create empty vector to store output</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">Compadre<span class="op">$</span>dim &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(Compadre))</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co"># loop through all rows of Compadre</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="cf">for</span>(i <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_len</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(Compadre))) {</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  Compadre<span class="op">$</span>dim[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(Compadre<span class="op">$</span>matA[[i]])</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">}</a></code></pre></div>
</div>
<div id="vectorized-approach" class="section level4">
<h4 class="hasAnchor">
<a href="#vectorized-approach" class="anchor"></a>Vectorized approach</h4>
<p>An even nicer approach is to <em>vectorize</em> the function <code><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow()</a></code> over the vector <code>Compadre$matA</code> using <code><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply()</a></code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">Compadre<span class="op">$</span>dim &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(Compadre<span class="op">$</span>matA, nrow)</a></code></pre></div>
<p><code><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply()</a></code> applies the function specified in the 2nd argument (<code><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow()</a></code>) to every element of the vector in the first argument (<code>Compadre$matA</code>), and returns a vector of the results. The advantage of <code><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply()</a></code> over the loop is that we don’t need to pre-define an object to store the results.</p>
</div>
<div id="vectorizing-custom-functions" class="section level4">
<h4 class="hasAnchor">
<a href="#vectorizing-custom-functions" class="anchor"></a>Vectorizing custom functions</h4>
<p>We can also vectorize with a custom function. Let’s say we want to know, for every matrix, whether there are stages with no transitions (i.e. any column sums equal to zero). Here’s a vectorized approach.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># function to determine whether matrix 'mat' has any stages with no transitions</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">NullStages &lt;-<span class="st"> </span><span class="cf">function</span>(mat) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/any">any</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colSums</a></span>(mat) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co"># apply function to every element of A</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">Compadre<span class="op">$</span>null_stages &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(Compadre<span class="op">$</span>matA, NullStages)</a></code></pre></div>
<p>The key to vectorizing is to make sure the function works on individual elements of the vector.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">NullStages</span>(Compadre<span class="op">$</span>matA[[<span class="dv">1</span>]]) <span class="co"># apply function to single element</span></a></code></pre></div>
</div>
</div>
<div id="accessor-functions-and-vectorization" class="section level2">
<h2 class="hasAnchor">
<a href="#accessor-functions-and-vectorization" class="anchor"></a>Accessor functions and vectorization</h2>
<p>Note that, in the example above, it wasn’t necessary to create the column <code>Compadre$matA</code> before vectorizing over the <strong>A</strong> matrices. We could have simply used the <code><a href="../reference/CompadreMatrixMethods.html">matA()</a></code> accessor within <code><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">Compadre<span class="op">$</span>null_stages &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(<span class="kw"><a href="../reference/CompadreMatrixMethods.html">matA</a></span>(Compadre), NullStages)</a></code></pre></div>
<div id="using-cdb_unnest-to-avoid-accessors" class="section level4">
<h4 class="hasAnchor">
<a href="#using-cdb_unnest-to-avoid-accessors" class="anchor"></a>Using <code><a href="../reference/cdb_unnest.html">cdb_unnest()</a></code> to avoid accessors</h4>
<p>That said, using accessor funtions can get tedious. Rather than constantly using accessor functions to extract components of the <code>mat</code> column, we could use the function <code><a href="../reference/cdb_unnest.html">cdb_unnest()</a></code> to extract separate columns for all matrix components at the start of our analysis.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># create new columns matA, matU, matF, matC, MatrixClassAuthor, etc..</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">CompUnnest &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cdb_unnest.html">cdb_unnest</a></span>(Compadre)</a></code></pre></div>
<p>Then we can refer to any component using <code>$</code>, e.g.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># apply NullStages to every matA</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">CompUnnest<span class="op">$</span>null_stages &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(CompUnnest<span class="op">$</span>matA, NullStages)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3"></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="co"># count number of dormant stages in every MatrixClassOrganized</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">NumberDormant &lt;-<span class="st"> </span><span class="cf">function</span>(stages) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(stages <span class="op">==</span><span class="st"> "dorm"</span>))</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">CompUnnest<span class="op">$</span>n_dormant &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(CompUnnest<span class="op">$</span>MatrixClassOrganized, NumberDormant)</a></code></pre></div>
</div>
</div>
<div id="other-apply-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#other-apply-functions" class="anchor"></a>Other apply functions</h2>
<p><code><a href="https://www.rdocumentation.org/packages/base/topics/lapply">vapply()</a></code> is similar to <code><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply()</a></code>, except that the output type is specified as an argument.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(CompUnnest<span class="op">$</span>matA[<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>], nrow)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="co">#&gt; [1] 4 6 3 5 5 3</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">vapply</a></span>(CompUnnest<span class="op">$</span>matA[<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>], nrow, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>(<span class="dv">1</span>)) <span class="co"># must specify output type</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co">#&gt; [1] 4 6 3 5 5 3</span></a></code></pre></div>
<p><code><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply()</a></code> always returns a list, so it’s useful if our output is more complex than a single value for each input. For example, we could use lapply to calculate vectors of stage-specific survival (column sums of matU).</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(CompUnnest<span class="op">$</span>matU[<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>], <span class="cf">function</span>(m) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colSums</a></span>(m))</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="co">#&gt;   U1   U2   U3   U4 </span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#&gt; 0.84 0.73 0.93 0.91 </span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="co">#&gt;     U1     U2     U3     U4     U5     U6 </span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="co">#&gt; 0.8433 0.8810 0.9480 0.9290 1.0000 0.9450 </span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="co">#&gt; [[3]]</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="co">#&gt;    U1    U2    U3 </span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="co">#&gt; 0.672 0.903 0.997 </span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="co">#&gt; [[4]]</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="co">#&gt;      U1      U2      U3      U4      U5 </span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="co">#&gt; 0.83820 0.82850 0.75345 0.86665 0.05000</span></a></code></pre></div>
<p><code><a href="https://www.rdocumentation.org/packages/base/topics/mapply">mapply()</a></code> is for vectorizing over multiple arguments. For example, the <code>lifeExpectancy()</code> function below (taken from the package <a href="https://github.com/jonesor/Rage">Rage</a>) calculates life expectancy given two arguments: a <strong>U</strong> matrix, and an integer indicator for the stage class reflecting the ‘start of life’. The start of life is often defined as the first ‘active’ stage class (i.e. not propagule or dormant), the index of which will vary from row to row.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># function to calculate life expectancy</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">lifeExpectancy &lt;-<span class="st"> </span><span class="cf">function</span>(matU, startLife) {</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  N &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/solve">solve</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(matU)) <span class="op">-</span><span class="st"> </span>matU)</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colSums</a></span>(N)[startLife])</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb14-6" data-line-number="6"></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="co"># get index of first active stage class with mpm_first_active()</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8">CompUnnest<span class="op">$</span>start_life &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mpm_methods.html">mpm_first_active</a></span>(CompUnnest)</a>
<a class="sourceLine" id="cb14-9" data-line-number="9"></a>
<a class="sourceLine" id="cb14-10" data-line-number="10"><span class="co"># vectorize lifeExpectancy over matU and start_life</span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mapply">mapply</a></span>(lifeExpectancy,             <span class="co"># function</span></a>
<a class="sourceLine" id="cb14-12" data-line-number="12">       CompUnnest<span class="op">$</span>matU[<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>],       <span class="co"># first argument to vectorize over</span></a>
<a class="sourceLine" id="cb14-13" data-line-number="13">       CompUnnest<span class="op">$</span>start_life[<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>]) <span class="co"># second argument to vectorize over</span></a>
<a class="sourceLine" id="cb14-14" data-line-number="14"><span class="co">#&gt; [1]  5.727060 22.194872  8.439966  3.009829 10.877215 18.181818</span></a></code></pre></div>
</div>
<div id="when-functions-fail" class="section level2">
<h2 class="hasAnchor">
<a href="#when-functions-fail" class="anchor"></a>When functions fail</h2>
<p>Just like loops, vectorization fails if the function being vectorized throws an error on <em>any</em> element of the vector. Here’s an example. The <code><a href="https://www.rdocumentation.org/packages/popbio/topics/lambda">lambda()</a></code> function from <a href="https://cran.r-project.org/web/packages/popbio/index.html">popbio</a> calculates the expected population growth rate given a projection matrix. It’ll work on most of the <strong>A</strong> matrices in <code>Compadre</code>, but fails on matrices that contain missing values (<code>NA</code>).</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># works for a single matrix</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/popbio/topics/lambda">lambda</a></span>(CompUnnest<span class="op">$</span>matA[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="co">#&gt; [1] 1.058029</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co"># but fails when applied to all matrices because a few have missing values</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6">CompUnnest<span class="op">$</span>lambda &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(CompUnnest<span class="op">$</span>matA, lambda)</a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="co">#&gt; Error in eigen(A): infinite or missing values in 'x'</span></a></code></pre></div>
<p>There are two basic approaches to overcoming this:</p>
<div id="remove-or-skip-problem-elements" class="section level4">
<h4 class="hasAnchor">
<a href="#remove-or-skip-problem-elements" class="anchor"></a>1. Remove or skip problem elements</h4>
<p>If <code><a href="https://www.rdocumentation.org/packages/popbio/topics/lambda">lambda()</a></code> doesn’t work on matrices with missing values, one approach is to simply remove matrices with missing values. The <code><a href="../reference/cdb_flag.html">cdb_flag()</a></code> function is an easy way to check for missing values, and other common issues that might hinder our analyses.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co"># add column 'check_NA_A', indicating whether matA contains missing values (T/F)</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">CompFlag &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cdb_flag.html">cdb_flag</a></span>(CompUnnest, <span class="dt">checks =</span> <span class="st">"check_NA_A"</span>)</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="co"># remove rows where matA contains missing values</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">CompSub &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/subset">subset</a></span>(CompFlag, check_NA_A <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb16-6" data-line-number="6"></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="co"># apply lambda() to every remaining matA</span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8">CompSub<span class="op">$</span>lambda &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(CompSub<span class="op">$</span>matA, lambda)</a></code></pre></div>
<p>Alternatively, if we want to avoid subsetting, we could pre-define a placeholder column for the result, and then selectively apply the <code><a href="https://www.rdocumentation.org/packages/popbio/topics/lambda">lambda()</a></code> function to only those matrices that don’t contain missing values.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co"># identify rows with no missing values in matA</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2">no_missing &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(CompFlag<span class="op">$</span>check_NA_A <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3"></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="co"># create placeholder column for lambda</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5">CompFlag<span class="op">$</span>lambda &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6"></a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="co"># apply lambda() to all matA with no missing values</span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8">CompFlag<span class="op">$</span>lambda[no_missing] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(CompFlag<span class="op">$</span>matA[no_missing], lambda)</a></code></pre></div>
<p>Rows where there were missing values in matA retain the original placeholder value of <code>NA</code>.</p>
</div>
<div id="modify-the-function" class="section level4">
<h4 class="hasAnchor">
<a href="#modify-the-function" class="anchor"></a>2. Modify the function</h4>
<p>A second approach is to modify the function we want to vectorize with so that it can natively handle special cases. For example, we might modify <code><a href="https://www.rdocumentation.org/packages/popbio/topics/lambda">lambda()</a></code> so that it returns <code>NA</code> if a matrix contains missing values.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">lambda2 &lt;-<span class="st"> </span><span class="cf">function</span>(mat) {</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">  <span class="co"># check mat for missing values: if TRUE return NA, else return lambda(mat)</span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/any">any</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(mat)), <span class="ot">NA</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/popbio/topics/lambda">lambda</a></span>(mat))     </a>
<a class="sourceLine" id="cb18-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb18-5" data-line-number="5"></a>
<a class="sourceLine" id="cb18-6" data-line-number="6">CompUnnest<span class="op">$</span>lambda &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(CompUnnest<span class="op">$</span>matA, lambda2)</a></code></pre></div>
<p>If the special cases are harder to test for, we could use R’s condition-handling functions like <code><a href="https://www.rdocumentation.org/packages/base/topics/try">try()</a></code> or <code><a href="https://www.rdocumentation.org/packages/base/topics/conditions">tryCatch()</a></code>. Here’s an example.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">lambda3 &lt;-<span class="st"> </span><span class="cf">function</span>(mat) {</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">  <span class="co"># try lambda(mat): if error return NA</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/conditions">tryCatch</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/popbio/topics/lambda">lambda</a></span>(mat), <span class="dt">error =</span> <span class="cf">function</span>(err) <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb19-4" data-line-number="4">} </a>
<a class="sourceLine" id="cb19-5" data-line-number="5"></a>
<a class="sourceLine" id="cb19-6" data-line-number="6">CompUnnest<span class="op">$</span>lambda &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(CompUnnest<span class="op">$</span>matA, lambda3)</a></code></pre></div>
<p>This latter approach requires caution, as we’ll get an <code>NA</code> for <em>any</em> error. Some errors might reflect problems with our data or code that are fixable, in which case an <code>NA</code> may be misleading.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#preliminaries">Preliminaries</a></li>
      <li><a href="#introduction-to-vectorization">Introduction to vectorization</a></li>
      <li><a href="#accessor-functions-and-vectorization">Accessor functions and vectorization</a></li>
      <li><a href="#other-apply-functions">Other apply functions</a></li>
      <li><a href="#when-functions-fail">When functions fail</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Patrick Barks, Danny Buss, Roberto Salguero-Gomez, Iain Stott, Tamora James, Owen Jones, Julia Jones.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
