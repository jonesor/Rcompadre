<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Vectorising with Rcompadre • Rcompadre</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Vectorising with Rcompadre">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Rcompadre</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.4.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a01_GettingStarted.html">Getting started with Rcompadre</a></li>
    <li><a class="dropdown-item" href="../articles/a02_RcompadreTidy.html">Using Rcompadre with the tidyverse</a></li>
    <li><a class="dropdown-item" href="../articles/a03_VectorisingRcompadre.html">Vectorising with Rcompadre</a></li>
    <li><a class="dropdown-item" href="../articles/a04_ObtainingReferences.html">Obtaining references</a></li>
    <li><a class="dropdown-item" href="../articles/a05_UsingYourOwnData.html">Using your own matrix data</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="nav-link" href="https://github.com/jonesor/Rcompadre/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Vectorising with Rcompadre</h1>
                        <h4 data-toc-skip class="author">Patrick
Barks</h4>
            
            <h4 data-toc-skip class="date">2024-10-16</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jonesor/Rcompadre/blob/HEAD/vignettes/a03_VectorisingRcompadre.Rmd"><code>vignettes/a03_VectorisingRcompadre.Rmd</code></a></small>
      <div class="d-none name"><code>a03_VectorisingRcompadre.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>COM(P)ADRE databases contain thousands of matrix population models.
If we want to derive traits from a large set of these matrices, we’ll
need to use either loops or vectorisation.</p>
<p>Vectorising means applying a function to each element of a vector.
Here vector is defined broadly - it could be a sequence of character
strings, a column of a <code>data.frame</code>, a <code>list</code> of
matrices, etc. Vectorised code generally runs faster than loops, and
many R users find that vectorised code is easier to write and
understand.</p>
</div>
<div class="section level2">
<h2 id="preliminaries">Preliminaries<a class="anchor" aria-label="anchor" href="#preliminaries"></a>
</h2>
<p>We’ll start by loading a few packages and a dataset that we’ll be
using throughout this vignette. The dataset <code>Compadre</code> is a
subset of a recent COMPADRE release that’s built into
<code>Rcompadre</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jonesor/Rcompadre">Rcompadre</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">popdemo</span><span class="op">)</span></span>
<span><span class="co">#&gt; Welcome to popdemo! This is version 1.3-0</span></span>
<span><span class="co">#&gt; Use ?popdemo for an intro, or browseVignettes('popdemo') for vignettes</span></span>
<span><span class="co">#&gt; Citation for popdemo is here: doi.org/10.1111/j.2041-210X.2012.00222.x</span></span>
<span><span class="co">#&gt; Development and legacy versions are here: github.com/iainmstott/popdemo</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="introduction-to-vectorisation">Introduction to vectorisation<a class="anchor" aria-label="anchor" href="#introduction-to-vectorisation"></a>
</h2>
<p>To understand vectorisation, we first need a vector. For this
purpose, we’ll extract a list of <strong>A</strong> matrices from the
<code>mat</code> column of <code>Compadre</code>, and add this list of
matrices to <code>Compadre</code> as a new column.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Compadre</span><span class="op">$</span><span class="va">matA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CompadreMatrixMethods.html">matA</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">)</span></span></code></pre></div>
<p>This new column, <code>Compadre$matA</code>, is both a vector and a
list.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">is.vector</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">$</span><span class="va">matA</span><span class="op">)</span> <span class="co"># it really is a vector</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">is.list</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">$</span><span class="va">matA</span><span class="op">)</span> <span class="co"># and also a list</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">$</span><span class="va">matA</span><span class="op">)</span> <span class="co"># with 150 matrices</span></span>
<span><span class="co">#&gt; [1] 150</span></span>
<span><span class="va">Compadre</span><span class="op">$</span><span class="va">matA</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="co"># here are the first three</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;      A1   A2   A3   A4</span></span>
<span><span class="co">#&gt; A1 0.61 0.38 0.30 1.16</span></span>
<span><span class="co">#&gt; A2 0.23 0.50 0.31 0.32</span></span>
<span><span class="co">#&gt; A3 0.00 0.18 0.54 0.41</span></span>
<span><span class="co">#&gt; A4 0.00 0.05 0.08 0.50</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;        A1    A2    A3       A4       A5        A6</span></span>
<span><span class="co">#&gt; A1 0.8430 0.000 0.000 176.0600 635.7200 1601.2500</span></span>
<span><span class="co">#&gt; A2 0.0003 0.000 0.000   0.0584   0.2109    0.5313</span></span>
<span><span class="co">#&gt; A3 0.0000 0.476 0.132   0.1430   0.0000    0.0560</span></span>
<span><span class="co">#&gt; A4 0.0000 0.095 0.105   0.2860   0.0000    0.0000</span></span>
<span><span class="co">#&gt; A5 0.0000 0.167 0.474   0.4290   0.8000    0.0000</span></span>
<span><span class="co">#&gt; A6 0.0000 0.143 0.237   0.0710   0.2000    0.8890</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt;       A1    A2    A3</span></span>
<span><span class="co">#&gt; A1 0.017 0.000 1.142</span></span>
<span><span class="co">#&gt; A2 0.655 0.902 0.009</span></span>
<span><span class="co">#&gt; A3 0.000 0.001 0.988</span></span></code></pre></div>
<p>Let’s say we want to calculate the dimension of every matrix in
<code>Compadre$matA</code>. In fact, <code>Compadre</code> already has
this data in the column ‘MatrixDimension’, but let’s say we want to
double-check it. We’ll use the function <code><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow()</a></code>, and assume
that the number of rows and columns are equal. But we can’t use
<code><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow()</a></code> directly on <code>Compadre$matA</code>, because the
function <code><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow()</a></code> isn’t vectorised. It can only take one
object at a time.</p>
<div class="section level4">
<h4 id="manual-approach">Manual approach<a class="anchor" aria-label="anchor" href="#manual-approach"></a>
</h4>
<p>We could do something like this…</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Compadre</span><span class="op">$</span><span class="va">dim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">)</span><span class="op">)</span> <span class="co"># create empty vector to store output</span></span>
<span><span class="va">Compadre</span><span class="op">$</span><span class="va">dim</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">$</span><span class="va">matA</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="co"># nrow matrix 1</span></span>
<span><span class="va">Compadre</span><span class="op">$</span><span class="va">dim</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">$</span><span class="va">matA</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="co"># nrow matrix 2</span></span>
<span><span class="va">Compadre</span><span class="op">$</span><span class="va">dim</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">$</span><span class="va">matA</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="co"># nrow matrix 3</span></span>
<span><span class="co"># ... all the way to 150</span></span></code></pre></div>
<p>But that’s not very efficient for 150 matrices.</p>
</div>
<div class="section level4">
<h4 id="loop-approach">Loop approach<a class="anchor" aria-label="anchor" href="#loop-approach"></a>
</h4>
<p>A loop would be much more efficient here.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create empty vector to store output</span></span>
<span><span class="va">Compadre</span><span class="op">$</span><span class="va">dim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># loop through all rows of Compadre</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Compadre</span><span class="op">$</span><span class="va">dim</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">$</span><span class="va">matA</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="vectorised-approach">Vectorised approach<a class="anchor" aria-label="anchor" href="#vectorised-approach"></a>
</h4>
<p>An even nicer approach is to <em>vectorise</em> the function
<code><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow()</a></code> over the vector <code>Compadre$matA</code> using
<code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply()</a></code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Compadre</span><span class="op">$</span><span class="va">dim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">$</span><span class="va">matA</span>, <span class="va">nrow</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply()</a></code> applies the function specified in the 2nd
argument (<code><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow()</a></code>) to every element of the vector in the
first argument (<code>Compadre$matA</code>), and returns a vector of the
results. The advantage of <code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply()</a></code> over the loop is that we
don’t need to pre-define an object to store the results.</p>
</div>
<div class="section level4">
<h4 id="vectorising-custom-functions">Vectorising custom functions<a class="anchor" aria-label="anchor" href="#vectorising-custom-functions"></a>
</h4>
<p>We can also vectorise with a custom function. Let’s say we want to
know, for every matrix, whether there are stages with no transitions
(i.e. any column sums equal to zero). Here’s a vectorised approach.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># function to determine whether matrix 'mat' has any stages with no transitions</span></span>
<span><span class="va">NullStages</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># apply function to every element of A</span></span>
<span><span class="va">Compadre</span><span class="op">$</span><span class="va">null_stages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">$</span><span class="va">matA</span>, <span class="va">NullStages</span><span class="op">)</span></span></code></pre></div>
<p>The key to vectorising is to make sure the function works on
individual elements of the vector.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">NullStages</span><span class="op">(</span><span class="va">Compadre</span><span class="op">$</span><span class="va">matA</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="co"># apply function to single element</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="accessor-functions-and-vectorisation">Accessor functions and vectorisation<a class="anchor" aria-label="anchor" href="#accessor-functions-and-vectorisation"></a>
</h2>
<p>Note that, in the example above, it wasn’t necessary to create the
column <code>Compadre$matA</code> before vectorising over the
<strong>A</strong> matrices. We could have simply used the
<code><a href="../reference/CompadreMatrixMethods.html">matA()</a></code> accessor within <code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Compadre</span><span class="op">$</span><span class="va">null_stages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="../reference/CompadreMatrixMethods.html">matA</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">)</span>, <span class="va">NullStages</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="using-cdb_unnest-to-avoid-accessors">Using <code>cdb_unnest()</code> to avoid accessors<a class="anchor" aria-label="anchor" href="#using-cdb_unnest-to-avoid-accessors"></a>
</h4>
<p>That said, using accessor funtions can get tedious. Rather than
constantly using accessor functions to extract components of the
<code>mat</code> column, we could use the function
<code><a href="../reference/cdb_unnest.html">cdb_unnest()</a></code> to extract separate columns for all matrix
components at the start of our analysis.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create new columns matA, matU, matF, matC, MatrixClassAuthor, etc..</span></span>
<span><span class="va">CompUnnest</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cdb_unnest.html">cdb_unnest</a></span><span class="op">(</span><span class="va">Compadre</span><span class="op">)</span></span></code></pre></div>
<p>Then we can refer to any component using <code>$</code>, e.g.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># apply NullStages to every matA</span></span>
<span><span class="va">CompUnnest</span><span class="op">$</span><span class="va">null_stages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">CompUnnest</span><span class="op">$</span><span class="va">matA</span>, <span class="va">NullStages</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># count number of dormant stages in every MatrixClassOrganized</span></span>
<span><span class="va">NumberDormant</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">stages</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">stages</span> <span class="op">==</span> <span class="st">"dorm"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">CompUnnest</span><span class="op">$</span><span class="va">n_dormant</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">CompUnnest</span><span class="op">$</span><span class="va">MatrixClassOrganized</span>, <span class="va">NumberDormant</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="other-apply-functions">Other apply functions<a class="anchor" aria-label="anchor" href="#other-apply-functions"></a>
</h2>
<p><code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply()</a></code> is similar to <code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply()</a></code>, except
that the output type is specified as an argument.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">CompUnnest</span><span class="op">$</span><span class="va">matA</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>, <span class="va">nrow</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4 6 3 5 5 3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">CompUnnest</span><span class="op">$</span><span class="va">matA</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>, <span class="va">nrow</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="co"># must specify output type</span></span>
<span><span class="co">#&gt; [1] 4 6 3 5 5 3</span></span></code></pre></div>
<p><code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply()</a></code> always returns a <code>list</code>, so it’s
useful if our output is more complex than a single value for each input.
For example, we could use <code>lapply</code> to calculate vectors of
stage-specific survival (column sums of <code>matU</code>).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">CompUnnest</span><span class="op">$</span><span class="va">matU</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;   U1   U2   U3   U4 </span></span>
<span><span class="co">#&gt; 0.84 0.73 0.93 0.91 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;     U1     U2     U3     U4     U5     U6 </span></span>
<span><span class="co">#&gt; 0.8433 0.8810 0.9480 0.9290 1.0000 0.9450 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt;    U1    U2    U3 </span></span>
<span><span class="co">#&gt; 0.672 0.903 0.997 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt;      U1      U2      U3      U4      U5 </span></span>
<span><span class="co">#&gt; 0.83820 0.82850 0.75345 0.86665 0.05000</span></span></code></pre></div>
<p><code><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply()</a></code> is for vectorising over multiple arguments. For
example, the <code>lifeExpectancy()</code> function below (taken from
the package <a href="https://github.com/jonesor/Rage" class="external-link">Rage</a>)
calculates life expectancy given two arguments: a <strong>U</strong>
matrix, and an integer indicator for the stage class reflecting the
‘start of life’. The start of life is often defined as the first
‘active’ stage class (i.e. not propagule or dormant), the index of which
will vary from row to row.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># function to calculate life expectancy</span></span>
<span><span class="va">lifeExpectancy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">matU</span>, <span class="va">startLife</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">matU</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="va">matU</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">[</span><span class="va">startLife</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># get index of first active stage class with mpm_first_active()</span></span>
<span><span class="va">CompUnnest</span><span class="op">$</span><span class="va">start_life</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mpm_methods.html">mpm_first_active</a></span><span class="op">(</span><span class="va">CompUnnest</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># vectorise lifeExpectancy over matU and start_life</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span></span>
<span>  <span class="va">lifeExpectancy</span>, <span class="co"># function</span></span>
<span>  <span class="va">CompUnnest</span><span class="op">$</span><span class="va">matU</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>, <span class="co"># first argument to vectorise over</span></span>
<span>  <span class="va">CompUnnest</span><span class="op">$</span><span class="va">start_life</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span></span>
<span><span class="op">)</span> <span class="co"># second argument to vectorise over</span></span>
<span><span class="co">#&gt;        U1        U2        U1        U1        U1        U1 </span></span>
<span><span class="co">#&gt;  5.727060 22.194872  8.439966  3.009829 10.877215 18.181818</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="when-functions-fail">When functions fail<a class="anchor" aria-label="anchor" href="#when-functions-fail"></a>
</h2>
<p>Just like loops, vectorisation fails if the function being vectorised
throws an error on <em>any</em> element of the vector. Here’s an
example. The <code><a href="https://rdrr.io/pkg/popdemo/man/eigs.html" class="external-link">eigs()</a></code> function from <a href="https://CRAN.R-project.org/package=popdemo" class="external-link">popdemo</a> calculates
the expected population growth rate given a projection matrix. It’ll
work on most of the <strong>A</strong> matrices in
<code>Compadre</code>, but fails on matrices that contain missing values
(<code>NA</code>).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># works for a single matrix</span></span>
<span><span class="fu">popdemo</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/popdemo/man/eigs.html" class="external-link">eigs</a></span><span class="op">(</span><span class="va">CompUnnest</span><span class="op">$</span><span class="va">matA</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, what <span class="op">=</span> <span class="st">"lambda"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.058029</span></span>
<span></span>
<span><span class="co"># but fails when applied to all matrices because a few have missing values</span></span>
<span><span class="va">CompUnnest</span><span class="op">$</span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">CompUnnest</span><span class="op">$</span><span class="va">matA</span>, <span class="fu">popdemo</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/popdemo/man/eigs.html" class="external-link">eigs</a></span>, what <span class="op">=</span> <span class="st">"lambda"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eigen(A): infinite or missing values in 'x'</span></span></code></pre></div>
<p>There are two basic approaches to overcoming this:</p>
<div class="section level4">
<h4 id="remove-or-skip-problem-elements">1. Remove or skip problem elements<a class="anchor" aria-label="anchor" href="#remove-or-skip-problem-elements"></a>
</h4>
<p>If <code><a href="https://rdrr.io/pkg/popdemo/man/eigs.html" class="external-link">eigs()</a></code> doesn’t work on matrices with missing values,
one approach is to simply remove matrices with missing values. The
<code><a href="../reference/cdb_flag.html">cdb_flag()</a></code> function is an easy way to check for missing
values, and other common issues that might hinder our analyses.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># add column 'check_NA_A', indicating whether matA contains missing values (T/F)</span></span>
<span><span class="va">CompFlag</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cdb_flag.html">cdb_flag</a></span><span class="op">(</span><span class="va">CompUnnest</span>, checks <span class="op">=</span> <span class="st">"check_NA_A"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># remove rows where matA contains missing values</span></span>
<span><span class="va">CompSub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">CompFlag</span>, <span class="va">check_NA_A</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># apply lambda() to every remaining matA</span></span>
<span><span class="va">CompSub</span><span class="op">$</span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="../reference/CompadreMatrixMethods.html">matA</a></span><span class="op">(</span><span class="va">CompSub</span><span class="op">)</span>, <span class="fu">popdemo</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/popdemo/man/eigs.html" class="external-link">eigs</a></span>, what <span class="op">=</span> <span class="st">"lambda"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): More than one eigenvalues have equal absolute</span></span>
<span><span class="co">#&gt; magnitude</span></span></code></pre></div>
<p>Alternatively, if we want to avoid subsetting, we could pre-define a
placeholder column for the result, and then selectively apply the
<code><a href="https://rdrr.io/pkg/popdemo/man/eigs.html" class="external-link">eigs()</a></code> function to only those matrices that don’t contain
missing values.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># identify rows with no missing values in matA</span></span>
<span><span class="va">no_missing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">CompFlag</span><span class="op">$</span><span class="va">check_NA_A</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create placeholder column for lambda</span></span>
<span><span class="va">CompFlag</span><span class="op">$</span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="co"># apply eigs() to all matA with no missing values</span></span>
<span><span class="va">CompFlag</span><span class="op">$</span><span class="va">lambda</span><span class="op">[</span><span class="va">no_missing</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">CompFlag</span><span class="op">$</span><span class="va">matA</span><span class="op">[</span><span class="va">no_missing</span><span class="op">]</span>,</span>
<span>  <span class="fu">popdemo</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/popdemo/man/eigs.html" class="external-link">eigs</a></span>,</span>
<span>  what <span class="op">=</span> <span class="st">"lambda"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): More than one eigenvalues have equal absolute</span></span>
<span><span class="co">#&gt; magnitude</span></span></code></pre></div>
<p>Rows where there were missing values in <code>matA</code> retain the
original placeholder value of <code>NA</code>.</p>
</div>
<div class="section level4">
<h4 id="modify-the-function">2. Modify the function<a class="anchor" aria-label="anchor" href="#modify-the-function"></a>
</h4>
<p>A second approach is to modify the function we want to vectorise with
so that it can natively handle special cases. For example, we might
modify <code><a href="https://rdrr.io/pkg/popdemo/man/eigs.html" class="external-link">eigs()</a></code> so that it returns <code>NA</code> if a
matrix contains missing values.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lambdaFn1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># check mat for missing values: if TRUE return NA, else return eigs(mat)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">anyNA</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="fu">popdemo</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/popdemo/man/eigs.html" class="external-link">eigs</a></span><span class="op">(</span><span class="va">mat</span>, what <span class="op">=</span> <span class="st">"lambda"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">CompUnnest</span><span class="op">$</span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">CompUnnest</span><span class="op">$</span><span class="va">matA</span>, <span class="va">lambdaFn1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in popdemo::eigs(mat, what = "lambda"): More than one eigenvalues have</span></span>
<span><span class="co">#&gt; equal absolute magnitude</span></span></code></pre></div>
<p>If the special cases are harder to test for, we could use R’s
condition-handling functions like <code><a href="https://rdrr.io/r/base/try.html" class="external-link">try()</a></code> or
<code><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch()</a></code>. Here’s an example.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lambdaFn2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># try eigs(mat): if error return NA</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/popdemo/man/eigs.html" class="external-link">eigs</a></span><span class="op">(</span><span class="va">mat</span>, what <span class="op">=</span> <span class="st">"lambda"</span><span class="op">)</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">err</span><span class="op">)</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">CompUnnest</span><span class="op">$</span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">CompUnnest</span><span class="op">$</span><span class="va">matA</span>, <span class="va">lambdaFn2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in eigs(mat, what = "lambda"): More than one eigenvalues have equal</span></span>
<span><span class="co">#&gt; absolute magnitude</span></span></code></pre></div>
<p>This latter approach requires caution, as we’ll get an
<code>NA</code> for <em>any</em> error. Some errors might reflect
problems with our data or code that are fixable, in which case an
<code>NA</code> may be misleading.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Patrick Barks, Danny Buss, Roberto Salguero-Gomez, Iain Stott, William K. Petry, Tamora James, Owen Jones, Julia Jones, Gesa Römer, Sam Levin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
